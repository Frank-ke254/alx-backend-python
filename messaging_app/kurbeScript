#!/bin/bash

set -e

echo "Starting Kubernetes setup..."

if ! command -v minikube &> /dev/null
then
    echo "Minikube is not installed."
    echo "Installing Minikube..."

    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        sudo install minikube-linux-amd64 /usr/local/bin/minikube
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        brew install minikube
    elif [[ "$OS" == "Windows_NT" ]]; then
        echo "Please install Minikube manually for Windows:"
        echo "https://minikube.sigs.k8s.io/docs/start/"
        exit 1
    fi
else
    echo "Minikube is already installed."
fi

if ! command -v kubectl &> /dev/null
then
    echo "kubectl is not installed."
    echo "Installing kubectl..."
    
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        sudo apt-get update -y
        sudo apt-get install -y kubectl
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        brew install kubectl
    elif [[ "$OS" == "Windows_NT" ]]; then
        echo "Please install kubectl manually for Windows:"
        echo "https://kubernetes.io/docs/tasks/tools/"
        exit 1
    fi
else
    echo "kubectl is already installed."
fi

echo "Starting Minikube cluster..."
minikube start

echo "Verifying Kubernetes cluster status..."
kubectl cluster-info

echo "Retrieving current pods in all namespaces..."
kubectl get pods --all-namespaces

echo "Kubernetes cluster setup and verification complete!"
